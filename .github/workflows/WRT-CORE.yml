name: WRT-CORE

on:
  workflow_call:
    inputs:
      WRT_CONFIG:
        required: true
        type: string
      WRT_THEME:
        required: true
        type: string
      WRT_NAME:
        required: true
        type: string
      WRT_SSID:
        required: true
        type: string
      WRT_WORD:
        required: true
        type: string
      WRT_IP:
        required: true
        type: string
      WRT_PW:
        required: true
        type: string
      WRT_REPO:
        required: true
        type: string
      WRT_BRANCH:
        required: true
        type: string
      WRT_SOURCE:
        required: true
        type: string
      WRT_PACKAGE:
        required: false
        type: string
      WRT_TEST:
        required: false
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  WRT_CONFIG: ${{ inputs.WRT_CONFIG }}
  WRT_THEME: ${{ inputs.WRT_THEME }}
  WRT_NAME: ${{ inputs.WRT_NAME }}
  WRT_SSID: ${{ inputs.WRT_SSID }}
  WRT_WORD: ${{ inputs.WRT_WORD }}
  WRT_IP: ${{ inputs.WRT_IP }}
  WRT_PW: ${{ inputs.WRT_PW }}
  WRT_REPO: ${{ inputs.WRT_REPO }}
  WRT_BRANCH: ${{ inputs.WRT_BRANCH }}
  WRT_SOURCE: ${{ inputs.WRT_SOURCE }}
  WRT_PACKAGE: ${{ inputs.WRT_PACKAGE }}
  WRT_TEST: ${{ inputs.WRT_TEST }}

  # ccache 相关
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_COMPRESS: "1"
  CCACHE_MAXSIZE: "3G"

permissions:
  contents: write

jobs:
  core:
    name: ${{ inputs.WRT_SOURCE }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Projects
        uses: actions/checkout@v4

      - name: Initialization Environment
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt -yqq purge firefox
          sudo -E apt -yqq update
          sudo -E apt -yqq full-upgrade
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E apt -yqq install dos2unix python3-netifaces libfuse-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E systemctl daemon-reload
          sudo -E timedatectl set-timezone "Asia/Shanghai"

          sudo mkdir -p /mnt/build_wrt
          sudo chown $USER:$USER /mnt/build_wrt
          sudo ln -s /mnt/build_wrt $GITHUB_WORKSPACE/wrt

      - name: Initialization Values
        shell: bash
        run: |
          set -euo pipefail

          echo "WRT_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> "$GITHUB_ENV"
          echo "WRT_MARK=${GITHUB_REPOSITORY%%/*}" >> "$GITHUB_ENV"
          echo "WRT_INFO=${WRT_SOURCE%%/*}" >> "$GITHUB_ENV"
          echo "WRT_TARGET=$(grep -m 1 -oP '^CONFIG_TARGET_\\K[\\w]+(?==y)' ./Config/"$WRT_CONFIG".txt)" >> "$GITHUB_ENV"
          echo "WRT_KVER=none" >> "$GITHUB_ENV"
          echo "WRT_LIST=none" >> "$GITHUB_ENV"

      - name: Clone Code
        shell: bash
        run: |
          set -euo pipefail

          git clone --depth=1 --single-branch --branch "$WRT_BRANCH" "$WRT_REPO" ./wrt/

          cd ./wrt/
          echo "WRT_HASH=$(git log -1 --pretty=format:'%h')" >> "$GITHUB_ENV"

          # GitHub Action 移除国内下载源
          PROJECT_MIRRORS_FILE="./scripts/projectsmirrors.json"
          if [ -f "$PROJECT_MIRRORS_FILE" ]; then
            sed -i '/.cn\//d; /tencent/d; /aliyun/d' "$PROJECT_MIRRORS_FILE"
          fi

      - name: Check Scripts
        shell: bash
        run: |
          set -euo pipefail
          find ./ -maxdepth 3 -type f -iregex ".*\(txt\|sh\)$" -exec dos2unix {} \; -exec chmod +x {} \;

      - name: Check Caches
        id: check-cache
        # if: env.WRT_TEST != 'true' && !contains(env.WRT_CONFIG, 'ROCK')
        uses: actions/cache@v4
        with:
          key: ${{ env.WRT_CONFIG }}-${{ env.WRT_INFO }}
          restore-keys: |
            ${{ env.WRT_CONFIG }}-${{ env.WRT_INFO }}
          path: |
            # ccache 缓存
            ${{ env.CCACHE_DIR }}
            ./wrt/.ccache

            # OpenWrt 下载的源码包
            ./wrt/dl

            # toolchain / host 工具链
            ./wrt/staging_dir/host*
            ./wrt/staging_dir/tool*

      - name: Update Caches
        # if: env.WRT_TEST != 'true' && !contains(env.WRT_CONFIG, 'ROCK')
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "./wrt/staging_dir" ]; then
            echo ">>> Refresh stamp timestamps in staging_dir (except target)..."
            find "./wrt/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r DIR; do
              find "$DIR" -type f -exec touch {} +
            done
            mkdir -p ./wrt/tmp && echo "1" > ./wrt/tmp/.build
            echo "toolchain skipped done!"
          else
            echo "caches missed!"
          fi

      - name: Clean Old Caches
        # 只有当没有命中缓存时才检查（不再删除）
        if: env.WRT_TEST != 'true' && steps.check-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v gh >/dev/null 2>&1; then
            echo "GitHub CLI (gh) not found, skip cache inspect."
            exit 0
          fi

          echo "No cache hit, list existing caches for key prefix: $WRT_CONFIG-$WRT_INFO"

          gh cache list --key "$WRT_CONFIG-$WRT_INFO" || true

          echo "Skip deleting caches to avoid 403 (GITHUB_TOKEN has no delete permission)."


      - name: Enable ccache
        # if: env.WRT_TEST != 'true' && !contains(env.WRT_CONFIG, 'ROCK')
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$CCACHE_DIR"
          echo ">>> Set ccache max size to ${CCACHE_MAXSIZE}"
          ccache -M "${CCACHE_MAXSIZE}" || true
          echo ">>> Current ccache status:"
          ccache -s || true


      - name: Update Feeds
        shell: bash
        run: |
          set -euo pipefail

          cd ./wrt/
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Custom Packages
        shell: bash
        run: |
          set -euo pipefail

          cd ./wrt/package/
          "$GITHUB_WORKSPACE/Scripts/Packages.sh"
          "$GITHUB_WORKSPACE/Scripts/Handles.sh"

      - name: Download private config file
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          cd ./wrt/

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "❌ GH_TOKEN not set, unable to access private repository qqsir-dev/config"
            echo "Please add GH_TOKEN in Settings → Secrets → Actions in this repository（PAT，Contents: Read）"
            exit 1
          fi

          REPO="qqsir-dev/config"
          REF="main"

          if echo "$WRT_CONFIG" | grep -Eiq "X86|64|86"; then
            FILE_PATH="ddns-go/home/ddns-go-config.yaml"
          elif echo "$WRT_CONFIG" | grep -Eiq "68"; then
            FILE_PATH="ddns-go/fhome/ddns-go-config.yaml"
          else
            echo "The current WRT_CONFIG=$WRT_CONFIG does not require downloading private configuration, skip"
            exit 0
          fi

          OUT="package/base-files/files/etc/ddns-go-config.yaml"

          mkdir -p "$(dirname "$OUT")"

          curl -fsSL \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/${REPO}/contents/${FILE_PATH}?ref=${REF}" \
            -o "$OUT"

          if [ ! -s "$OUT" ]; then
            echo "❌ Download failed: $OUT is empty (please check path/branch/permissions)"
            exit 1
          fi

          echo "✅ ${FILE_PATH} Download completed to：$OUT (Size: $(wc -c < "$OUT") Byte)"

      - name: Inject PPPoE into uci-defaults
        shell: bash
        env:
          PPPOE_X86_USER: ${{ secrets.PPPOE_X86_USER }}
          PPPOE_X86_PASS: ${{ secrets.PPPOE_X86_PASS }}
          PPPOE_R68_USER: ${{ secrets.PPPOE_R68_USER }}
          PPPOE_R68_PASS: ${{ secrets.PPPOE_R68_PASS }}
        run: |
          set -euo pipefail
          cd ./wrt/
          bash "$GITHUB_WORKSPACE/Scripts/write_uci_defaults.sh"

      
      - name: Custom Settings
        shell: bash
        run: |
          set -euo pipefail

          cd ./wrt/

          if [[ "${WRT_CONFIG,,}" == *"test"* ]]; then
            cat "$GITHUB_WORKSPACE/Config/$WRT_CONFIG.txt" >> .config
          else
            cat "$GITHUB_WORKSPACE/Config/$WRT_CONFIG.txt" "$GITHUB_WORKSPACE/Config/GENERAL.txt" >> .config
          fi

          "$GITHUB_WORKSPACE/Scripts/Settings.sh"

          # 这里不再 make clean，只做 defconfig
          make defconfig -j"$(nproc)"

      - name: Download Packages
        if: env.WRT_TEST != 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd ./wrt/
          make download -j"$(nproc)"

      - name: Compile Firmware
        if: env.WRT_TEST != 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd ./wrt/
          make -j"$(nproc)" || make -j1 V=s

      - name: Machine Information
        shell: bash
        run: |
          set -euo pipefail
          cd ./wrt/

          echo "======================="
          lscpu | grep -E "name|Core|Thread"
          echo "======================="
          df -h
          echo "======================="
          du -h --max-depth=1
          echo "======================="

      - name: Package Firmware
        run: |
          set -euo pipefail
          cd ./wrt/ && mkdir ./upload/

          cp -f ./.config ./upload/Config-"$WRT_CONFIG"-"$WRT_INFO"-"$WRT_BRANCH"-"$WRT_DATE".txt

          if [[ $WRT_TEST != 'true' ]]; then
            echo "WRT_KVER=$(find ./bin/targets/ -type f -name "*.manifest" -exec grep -oP '^kernel - \K[\d\.]+' {} \;)" >> $GITHUB_ENV
            echo "WRT_LIST=$(find ./bin/targets/ -type f -name "*.manifest" -exec grep -oP '^luci-(app|theme)[^ ]*' {} \; | tr '\n' ' ')" >> $GITHUB_ENV

            find ./bin/targets/ -iregex ".*\(buildinfo\|json\|sha256sums\|packages\)$" -exec rm -rf {} +

            for FILE in $(find ./bin/targets/ -type f -iname "*$WRT_TARGET*") ; do
              EXT=$(basename $FILE | cut -d '.' -f 2-)
              NAME=$(basename $FILE | cut -d '.' -f 1 | grep -io "\($WRT_TARGET\).*")
              NEW_FILE="$NAME"-"$WRT_DATE"-"$WRT_BRANCH"."$EXT"
              mv -f $FILE ./upload/$NEW_FILE
            done

            find ./bin/targets/ -type f -exec mv -f {} ./upload/ \;

            make clean -j$(nproc)
          fi

      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.WRT_CONFIG }}-${{ env.WRT_INFO }}-${{ env.WRT_BRANCH }}-${{ env.WRT_DATE }}
          files: ./wrt/upload/*.*
          body: |
            ${{ contains(env.WRT_CONFIG, 'ROCK') && '这是个平台固件包，内含多个设备！' || '' }}
            全系带开源硬件加速

            源码：${{ env.WRT_REPO }}
            分支：${{ env.WRT_BRANCH }}
            提交：${{ env.WRT_HASH }}

            配置：${{ env.WRT_CONFIG }}
            平台：${{ env.WRT_TARGET }}

            登录地址：${{ env.WRT_IP }}
            登录密码：${{ env.WRT_PW }}

            WIFI名称：${{ env.WRT_SSID }}
            WIFI密码：${{ env.WRT_WORD }}

            内核版本：${{ env.WRT_KVER }}
            插件列表：${{ env.WRT_LIST }}
